version: '3'

services:
  nats-server:
    image: nats:latest # descargo la √∫ltima versi√≥n de nats
    ports:
      - "8222:8222" # Expongo el 8222 que es el puerto por defecto para monitorear
                    # Expongo este puerto al exterior entre el cliente y el gateway, no la red interna
                    # No necesito exponerlo
  mongo:  # üëà Nuevo servicio
    image: mongo:7
    container_name: auth-mongo
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - ./auth-ms/mongo-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=auth-ms
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    healthcheck:
      test: |
        mongosh --eval "try { rs.status().ok } catch(e) { rs.initiate({_id:'rs0', members:[{_id:0, host:'mongo:27017'}]}).ok }"
      interval: 10s
      start_period: 30s
      
  client-gateway:
    depends_on:
      mongo:
        condition: service_healthy
      nats-server:
        condition: service_started
    build: ./client-gateway # Vendr√° a esta ruta a buscar el Dockerfile
    ports:
      - ${CLIENT_GATEWAY_PORT}:3000 # Comunico el puerto del pc con el del contenedor
    volumes:
      - ./client-gateway/src:/usr/src/app/src # Puedo enfocarme solo en el src lo mapeo a usr/src/app/src (node tiene este path)
    command: npm run start:dev
    environment: # definimos las variables de entorno, es como tener mi .env aqu√≠. Las validaciones que hice aplican aqui
      - PORT=3000
      - NATS_SERVERS=nats://nats-server:4222 # ya no uso localhost, uso nats-server
      - PRODUCTS_MICROSERVICE_HOST=products-ms # aqui tampoco uso localhost, uso el nombre del servicio
      - PRODUCTS_MICROSERVICE_PORT=3001
      - ORDERS_MICROSERVICE_HOST=orders-ms
      - ORDERS_MICROSERVICE_PORT=3002
  auth-ms:
    build: ./auth-ms
    volumes:
      - ./auth-ms/src:/usr/src/app/src # mapeo el src
    command: npm run start:dev
    environment:
      - PORT=3004
      - NATS_SERVERS=nats://nats-server:4222
      - DATABASE_URL=${AUTH_DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
  products-ms:
    depends_on:
      - nats-server
    build: ./products-ms
    volumes:
      - ./products-ms/src:/usr/src/app/src # mapeo el src
    command: npm run start:dev
    environment:
      - PORT=3001
      - NATS_SERVERS=nats://nats-server:4222
      - DATABASE_URL=file:./dev.db #products est√° en el filesystem porque uso SQLite
  orders-ms:
    depends_on:
      - orders-db # Este microservicio no debe levantarse sin la db (levantarse, no construir)
    build: ./orders-ms
    volumes:
      - ./orders-ms/src:/usr/src/app/src
    command: npm run start:dev
    environment:
      - PORT=3002
      - DATABASE_URL=postgresql://postgres:123456@orders-db:5432/ordersdb?schema=public
      - NATS_SERVERS=nats://nats-server:4222 
      - PRODUCTS_MICROSERVICE_HOST=products-ms
      - PRODUCTS_MICROSERVICE_PORT=3001
  payments-ms:
    env_file: .env
    container_name: payments-ms
    build: ./payments-ms
    volumes:
      - ./payments-ms/src:/usr/src/app/src
    command: npm run start:dev
    ports:
      - ${PAYMENTS_MS_PORT}:${PAYMENTS_MS_PORT}
    environment:
      - PORT=${PAYMENTS_MS_PORT}
      - NATS_SERVERS=nats://nats-server:4222 
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_ENDPOINT_SECRET=${STRIPE_ENDPOINT_SECRET} 
  orders-db:
    container_name: orders-database
    image: postgres:17
    restart: always
    volumes:
    - ./orders-ms/postgres:/var/lib/postgresql/data
    ports:
    - 5432:5432
    environment:
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=123456
    - POSTGRES_DB=ordersdb 
